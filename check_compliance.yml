---
- name: Scan for compliance 
  hosts: tag_compliance
  gather_facts: false
  tasks:
    - name: Simplified compliance check 
      block:
        - name: Verify the Windows folder permissions are properly set | windows-base-100
          win_file:
            path: C:\windows
            state: directory
          register: windowsbase100
          notify: create incident 

        - name: Safe DLL Search Mode is Enabled | windows-base-101
          win_regedit:
            path: HKLM:\System\CurrentControlSet\Control\Session Manager
            name: "SafeDllSearchMode"
            data: "0"
            type: dword
          register: windowsbase101
          notify: create incident 

        - name: Anonymous Access to Windows Shares and Named Pipes is Disallowed | windows-base-102
          win_regedit:
            path: HKLM:\System\CurrentControlSet\Services\LanManServer\Parameters
            name: "RestrictNullSessAccess"
            data: "1"
            type: dword
          register: windowsbase102
          notify: create incident 

        - name: All Shares are Configured to Prevent Anonymous Access | windows-base-103
          win_regedit:
            path: HKLM:\System\CurrentControlSet\Services\LanManServer\Parameters
            name: "NullSessionShares"
            data: ""
            type: multistring
          register: windowsbase103
          notify: create incident 

        - name: Force Encrypted Windows Network Passwords | windows-base-104
          win_regedit:
            path: HKLM:\System\CurrentControlSet\Services\LanmanWorkstation\Parameters
            name: "EnablePlainTextPassword"
            data: "0"
            type: dword
          register: windowsbase104
          notify: create incident 

        - name: Disable SMB1 to Windows Shares | windows-base-105
          win_regedit:
            path: HKLM:\System\CurrentControlSet\Services\LanManServer\Parameters
            name: "SMB1"
            data: "0"
            type: dword
          register: windowsbase105
          notify: create incident 

        - name: Strong Windows NTLMv2 Authentication Enabled; Weak LM Disabled | windows-base-201
          win_regedit:
            path: HKLM:\System\CurrentControlSet\Control\Lsa
            name: "LmCompatibilityLevel"
            data: "4"
            type: dword
          register: windowsbase201
          notify: create incident 

        - name: Enable Strong Encryption for Windows Network Sessions on Clients | windows-base-202
          win_regedit:
            path: HKLM:\System\CurrentControlSet\Control\Lsa\MSV1_0
            name: "NtlmMinClientSec"
            data: "537395200"
            type: dword
          register: windowsbase202
          notify: create incident 

        - name: Enable Strong Encryption for Windows Network Sessions on Servers | windows-base-203
          win_regedit:
            path: HKLM:\System\CurrentControlSet\Control\Lsa\MSV1_0
            name: "NtlmMinServerSec"
            data: "537395200"
            type: dword
          register: windowsbase203
          notify: create incident 
      

  handlers:
    - name: create incident
      snow_record:
        username: "{{ SN_USERNAME }}"
        password: "{{ SN_PASSWORD }}"
        instance: "{{ SN_INSTANCE }}"
        state: present
        table: incident
        data:
          short_description: "BANNER"
          severity: 3
          priority: 2
          caller_id: "System Administrator"
          comments: "The system is out of compliance on {{ inventory_hostname }}"
      register: snow_var
      check_mode: no
      become_user: awx 
      delegate_to: localhost
        