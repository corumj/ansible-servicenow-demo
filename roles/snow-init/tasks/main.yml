---
- name: Setup SNOW Custom Credential 
  awx.awx.tower_credential_type:
    name: ServiceNow
    description: Credentials type for ServiceNow
    kind: cloud
    inputs: "{{ lookup('file', 'files/inputs_snow.yml') | from_yaml }}"
    injectors: "{{ lookup('file', 'files/injectors_snow.yml') | from_yaml }}"
    state: present
    validate_certs: true
    tower_username: "{{ lookup('env', 'TOWER_USERNAME') }}"
    tower_password: "{{ lookup('env', 'TOWER_PASSWORD') }}"
    tower_host: "{{ lookup('env', 'TOWER_HOST') }}"

- name: Add custom credential
  awx.awx.tower_credential:
    name: SNOW 
    credential_type: ServiceNow 
    organization: Default 
    inputs:
      username: "{{ snow_username }}"
      password: "{{ snow_password }}"
      instance: "{{ snow_instance }}"
    tower_username: "{{ lookup('env', 'TOWER_USERNAME') }}"
    tower_password: "{{ lookup('env', 'TOWER_PASSWORD') }}"
    tower_host: "{{ lookup('env', 'TOWER_HOST') }}"
    tower_verify_ssl: true

- name: Spin up a Windows server to compliance check 
  awx.awx.tower_job_launch:
    job_template: 2. Provision
    extra_vars:
      survey_group_name: "compliance"
      survey_short_desc: "borg"
      survey_server_env: "dev" 
      survey_server_os: "windows"
      survey_business_domain_name: "Red Hat"
    tower_username: "{{ lookup('env', 'TOWER_USERNAME') }}"
    tower_password: "{{ lookup('env', 'TOWER_PASSWORD') }}"
    tower_host: "{{ lookup('env', 'TOWER_HOST') }}"
    tower_verify_ssl: true
  register: job 

- name: Wait for compliance target server to provision
  tower_job_wait:
    job_id: "{{ job.id }}"
    timeout: 1600

- name: Add ServiceNow - Compliance Check template 
  awx.awx.tower_job_template:
    name: "SNOW-Demo-Compliance-Check"
    job_type: run
    inventory: "AWS"
    project: "ServiceNow"
    playbook: check_compliance.yml
    credentials: 
      - "AWS Windows"
      - "SNOW"
    limit: "tag_compliance"
    state: present
    tower_username: "{{ lookup('env', 'TOWER_USERNAME') }}"
    tower_password: "{{ lookup('env', 'TOWER_PASSWORD') }}"
    tower_host: "{{ lookup('env', 'TOWER_HOST') }}"
    validate_certs: true